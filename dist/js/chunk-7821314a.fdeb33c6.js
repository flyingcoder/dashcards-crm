(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-7821314a"],{"9b31":function(e,t,s){"use strict";var a=s("f148"),n=s.n(a);n.a},b019:function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));var a=s("1be9"),n={get_chat_list:function(){return a["a"].get("api/chat/list?for=project&has_msg_count=true")},get_chat_list_only:function(){return a["a"].get("api/chat/list?for=project")},get_groupchat_list:function(){return a["a"].get("api/chat/group/list?for=project&has_msg_count=true")},get_members_list:function(e){return a["a"].get("api/chat/group/members/".concat(e))},get_messages:function(e){return a["a"].get("api/chat/private/".concat(e))},get_more_messages:function(e,t){return a["a"].get("api/chat/private/".concat(e,"?page=").concat(t+1))},get_group_messages:function(e){return a["a"].get("api/chat/group/private/".concat(e))},get_group_more_messages:function(e,t){return a["a"].get("api/chat/group/private/".concat(e,"?page=").concat(t+1))},send_message:function(e){return a["a"].post("api/chat/private",e,{headers:{"Content-Type":"multipart/form-data"}})},send_group_message:function(e){return a["a"].post("api/chat/group/private",e,{headers:{"Content-Type":"multipart/form-data"}})},save_group:function(e){return a["a"].post("api/chat/group",e)},update_members_list:function(e){return a["a"].post("api/chat/group/update-members",e)},remove_from_group:function(e){return a["a"].post("api/chat/group/remove-member",e)}}},b036:function(e,t,s){},b949:function(e,t,s){"use strict";var a=s("b036"),n=s.n(a);n.a},dd50:function(e,t,s){"use strict";s.r(t);var a=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",{staticClass:"message__body team-messages"},[e.can_manage_members?s("v-system-bar",{attrs:{"lights-out":"",height:40}},[s("v-spacer"),s("v-btn",{attrs:{text:"",small:""},on:{click:e.open_manage_member_dialog}},[e._v("Manage Members "),s("v-icon",{attrs:{right:""}},[e._v("settings")])],1)],1):e._e(),s("div",{ref:"messages-container",staticClass:"messages"},[e.can_send_message?s("v-row",{staticClass:"pa-3",attrs:{"no-gutters":""}},[s("v-spacer"),s("v-col",[!1!==e.noMoreData||e.loading?e._e():s("v-btn",{staticClass:"view__more_btn overline",attrs:{text:""},on:{click:e.load_previous}},[e._v("Load Previous Messages")])],1),s("v-spacer")],1):e._e(),e.loading?s("v-progress-linear",{attrs:{indeterminate:!0}}):e._e(),e.items.length&&e.can_send_message?s("v-row",{attrs:{"no-gutters":""}},[s("v-col",{staticClass:"px-3 py-2",staticStyle:{"min-height":"350px"},attrs:{md:"12"}},e._l(e.messages(e.items),(function(e){return s("Message",{key:e.id,attrs:{message:e}})})),1)],1):e.can_send_message?s("div",{staticClass:"no-messages"},[s("Empty",{attrs:{headline:"No messages yet"}})],1):s("div",{staticClass:"no-messages"},[s("Empty",{attrs:{headline:"Client messages unavailable! "}})],1)],1),s("div",{staticClass:"write px-3"},[e.can_send_message?s("ChatField",{staticClass:"mt-2",attrs:{mentionables:e.mentionables},on:{typing:function(e){},"send-message":e.sendMessage}}):e._e()],1),s("ManageClientChatMember",{ref:"manage_group_members_dialog",attrs:{conversation:e.activeChat}})],1)},n=[],i=(s("ac6a"),s("8615"),s("c5f6"),s("1be9"),s("1e4c")),r=s("579d"),c=s("e06e"),o=s("0644"),l=s.n(o),u=s("4752"),d=function(){var e=this,t=e.$createElement,s=e._self._c||t;return e.conversation?s("div",{staticClass:"text-center"},[s("v-dialog",{attrs:{"max-width":"800",persistent:"",scrollable:""},model:{value:e.dialog,callback:function(t){e.dialog=t},expression:"dialog"}},[s("v-card",[s("v-card-title",{staticClass:"headline grey lighten-2",attrs:{"primary-title":""}},[e._v(" Manage Members "),s("v-spacer"),s("v-icon",{on:{click:function(t){return e.clear_and_close()}}},[e._v("close")])],1),s("v-card-text",[s("v-container",[s("v-row",[s("v-flex",{attrs:{sm12:"",md8:""}},[s("v-text-field",{attrs:{solo:"",label:"Search for people to add",required:"",clearable:"","prepend-inner-icon":"search"},on:{keydown:e.filter_users,"click:clear":e.filter_users},model:{value:e.search,callback:function(t){e.search=t},expression:"search"}}),e.filtered_by_search.length>0?s("v-list",{attrs:{id:"filtered_by_search_wrapper"}},e._l(e.filtered_by_search,(function(t){return s("v-list-item",{key:t.title,on:{click:function(s){return e.selected(t)}}},[s("v-list-item-avatar",[s("v-img",{attrs:{src:t.image_url}})],1),s("v-list-item-content",[s("v-list-item-title",{domProps:{textContent:e._s(t.fullname)}})],1),s("v-list-item-icon",[s("v-icon",{directives:[{name:"show",rawName:"v-show",value:t.is_selected,expression:"item.is_selected"}],attrs:{color:"success"}},[e._v("mdi-checkbox-marked-circle")])],1)],1)})),1):e._e()],1),s("v-flex",{attrs:{sm12:"",md4:""}},[s("v-list",{attrs:{id:"all_selected_wrapper"}},[s("v-subheader",[e._v("Selected ("+e._s(e.all_selected.length)+")")]),e._l(e.all_selected,(function(t){return e.all_selected.length>0?s("v-list-item",{key:t.title},[s("v-list-item-avatar",[s("v-img",{attrs:{src:t.image_url}})],1),s("v-list-item-content",[s("v-list-item-subtitle",{domProps:{textContent:e._s(t.fullname)}})],1),e.can_be_remove(t)?s("v-list-item-icon",[s("v-icon",{attrs:{small:"",color:"danger"},on:{click:function(s){return e.selected(t)}}},[e._v("close")])],1):e._e()],1):e._e()}))],2)],1)],1)],1)],1),s("v-divider"),s("v-card-actions",[s("v-spacer"),s("v-btn",{on:{click:e.clear_and_close}},[e._v(" Cancel ")]),s("v-btn",{attrs:{color:"primary",loading:e.btnloading},on:{click:e.update_members}},[e._v(" Save ")])],1)],1)],1)],1):e._e()},_=[],m=(s("386d"),s("20d6"),s("6762"),s("2fdb"),s("b019")),g={name:"ManageClientChatMember",props:{conversation:Object},data:function(){return{dialog:!1,all_users:[],filtered_by_search:[],all_selected:[],search:"",btnloading:!1}},computed:{loggedUser:function(){return this.$store.getters.user}},methods:{open_dialog:function(){this.dialog=!0,this.all_selected=l()(this.conversation.members),this.get_chat_list()},clear_and_close:function(){this.dialog=!1},get_chat_list_only:function(){var e=this;m["a"].get_chat_list().then((function(t){var s=t.data;e.filtered_by_search=e.filter_users_for_selected(s),e.all_users=l()(s)}))},update_members:function(){var e=this;this.btnloading=!0;var t={convo_id:this.conversation.id,users:this.all_selected.map((function(e){return e.id}))};m["a"].update_members_list(t).then((function(t){var s=t.data;e.conversation.members=s,e.clear_and_close()})).finally((function(){return e.btnloading=!1}))},can_be_remove:function(e){if(e.id===this.loggedUser.id)return!1;if(e.is_company_owner)return!1;if(this.loggedUser.is_company_owner)return!0;var t=Object.values(this.loggedUser.user_roles)[0],s=Object.values(e.user_roles)[0];return(!t.includes("admin")||!s.includes("admin"))&&(!(!t.includes("admin")||s.includes("admin"))||(!t.includes("manager")||!s.includes("manager"))&&((!t.includes("manager")||!s.includes("admin"))&&(!t.includes("client")&&!t.includes("member"))))},select:function(e,t){var s=this.filtered_by_search.findIndex((function(t){return e.id===t.id}));~s&&(this.filtered_by_search[s].is_selected=t)},selected:function(e){var t=this.all_selected.findIndex((function(t){return e.id===t.id}));~t?(this.select(e,!1),this.all_selected.splice(t,1)):(this.select(e,!0),this.all_selected.push(e))},filter_users_for_selected:function(e){var t=this.conversation.members.map((function(e){return e.id}));return e.map((function(e){return Object.assign(e,{is_selected:t.indexOf(e.id)>=0})}))},filter_users:function(e){var t=this;setTimeout((function(){t.search&&""!==t.search?t.filtered_by_search=l()(t.all_users).filter((function(e){return e.fullname.toLowerCase().includes(t.search.toLowerCase().trim())})):t.filtered_by_search=l()(t.all_users)}),1)}}},h=g,f=(s("9b31"),s("2877")),p=Object(f["a"])(h,d,_,!1,null,"36f34b6a",null),v=p.exports,b=s("6bdf"),y=s("6385"),C={name:"ClientMessages",mixins:[r["a"],c["a"]],props:{id:[Number,String]},components:{Empty:u["a"],ManageClientChatMember:v,ChatField:b["a"],Message:y["a"]},data:function(){return{loading:!1,message:null,can_message:!1,activeChat:null}},computed:{loggedUser:function(){return this.$store.getters.user},can_manage_members:function(){if(this.loggedUser.is_admin)return!0;var e=Object.values(this.loggedUser.user_roles)[0];return!!~e.indexOf("manager")},can_send_message:function(){return this.can_message},mentionables:function(){return this.activeChat?this.activeChat.members:[]}},created:function(){this.loading=!0,this.getConvoDetails(this.id)},mounted:function(){this.$pusher.authenticate(),this.subscribePusher()},beforeDestroy:function(){this.$pusher.unsubscribe("private-project.client-message.".concat(this.id))},methods:{open_manage_member_dialog:function(){this.$refs.manage_group_members_dialog.open_dialog()},getConvoDetails:function(e){var t=this;i["a"](e).then((function(e){var s=e.data;t.activeChat=s})).finally((function(){t.loading=!1}))},scrollToBottomDiv:function(){var e=this;setTimeout((function(){var t=e.$refs["messages-container"];t&&(t.scrollTop=t.scrollHeight)}),1)},load_previous:function(){this.load_more_via_url("api/projects/".concat(this.id,"/messages?type=client"))},add_new_message:function(e){this.items.some((function(t){return t.id===e.id}))||this.items.unshift(e)},user_can_message:function(e){var t=this;this.can_message=e,e?(this.fill_table_via_url("api/projects/".concat(this.id,"/messages?type=client")),setTimeout((function(){t.scrollToBottomDiv()}),1),console.log("Client chat connected")):console.log("Client chat unavailable for you.")},subscribePusher:function(){var e=this,t=this.$pusher.subscribe("private-project.client-message.".concat(this.id));t.bind("ProjectClientMessage",(function(t){"client"===t.type&&e.add_new_message(t.message)})),t.bind("pusher:subscription_succeeded",(function(){return e.user_can_message(!0)})),t.bind("pusher:subscription_error",(function(t){return e.user_can_message(!1)}))},sendMessage:function(e){var t=this,s=new FormData;s.append("message",e.message),s.append("type","client"),s.append("from_id",this.loggedUser.id),e.files.length>0&&s.append("file",e.files[0]),i["b"](this.id,s).then((function(e){var s=e.data;t.add_new_message(s)})).finally((function(){t.scrollToBottomDiv(),t.$event.$emit("btnsending_off",!1)}))},messages:function(e){return l()(e).reverse()}}},w=C,x=(s("b949"),Object(f["a"])(w,a,n,!1,null,"52df3f66",null));t["default"]=x.exports},f148:function(e,t,s){}}]);
//# sourceMappingURL=chunk-7821314a.fdeb33c6.js.map